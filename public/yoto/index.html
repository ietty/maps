<!DOCTYPE html>
<html>

<head>
  <title>ietty Real Estates Maps</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
    }
    #address {
      width: 400px;
    }
  </style>
  <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
</head>

<body>
  <h1>ietty 不動産Maps</h1>
  <p>
    <ul>
      <li>住所を入力してその場所の正確な住所・用途区域等を表示</li>
      <li>クリックで移動して再検索</li>
      <li>用途区域の色分け表示</li>
    </ul>
  </p>
  <form onsubmit="return false;">
    住所や会社名等を入力:
    <input type="text" placeholder="株式会社ietty" id="address">
    <button type="submit" value="検索" id="map_button">検索</button>
  </form>
  <p>検索結果<br> 住所:
    <span id='formatted_address'></span></br>
    区域:<span id='yoto'></span></br>
    緯度:<span id='lat'></span></br>
    経度:<span id='lng'></span></br>
    </br>

    <!-- 地図を表示させる要素 -->
    <div class="map_box01">
      <div id="map-canvas" style="width: 1024px;height: 700px;"></div>
    </div>

  </p>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPnGpbDi_XQUZM1gyQj2GA8XzDDeJ4hMw&callback=initMap" async
    defer></script>

  <script>

    function Gmap() {
      let map;
      let geocoder;
      let marker;

      this.init = function () {
        // google.maps.Geocoder()コンストラクタのインスタンスを生成
        geocoder = new google.maps.Geocoder();
        // 地図表示に関するオプション
        const mapOptions = {
          zoom: 16,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        // 地図を表示させるインスタンスを生成
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      }

      this.codeAddress = function (query) {
        // geocoder.geocode()メソッドを実行 
        geocoder.geocode(query, (results, status) => {
          if (status == google.maps.GeocoderStatus.OK) {
            this.reloadMap(results[0]);
          } else {
            console.log('Geocode was not successful for the following reason: ' + status);
          }
        });

        // マップクリックをイベント登録
        map.addListener('click', (e) => {
          this.codeAddress({ 'location': e.latLng });
        });
      }

      // ジオコード成功時のMap書き換え
      this.reloadMap = function (result) {
        // 変換した緯度・経度情報を地図の中心に表示
        map.setCenter(result.geometry.location);
        // マーカー設定
        if (marker != undefined) marker.setMap(null);
        marker = new google.maps.Marker({ map: map, position: result.geometry.location });
        new google.maps.event.trigger(marker, 'click');
        //情報領域の書き換え
        this.changeInfo(result.geometry.location, result.formatted_address);
      }

      this.changeInfo = function (lat_lng, address) {
        //用途地域情報だけFusion Tables APIから取得
        url = 'https://www.googleapis.com/fusiontables/v2/query?key=AIzaSyCVSEoqIMlJDlvixxoS_hoSlvEFau6HFM4&';
        url += 'sql=SELECT * FROM 16RgKlH9yyaoou7SYvIYPIeOnQNXJl_RPMxoXA43k';
        url += ' where ST_INTERSECTS(geometry, CIRCLE(latlng' + lat_lng.toString() + ',9))';
        $.get(url, null, (results) => {
          yoto = ('00' + results.rows[0][5]).slice(-2) + '_' + results.rows[0][6];
          this.changeText(lat_lng, address, yoto);
        });
        yoto = "不明"
      }

      this.changeText = function (lat_lng, address, yoto) {
        //情報領域の書き換え
        $('#formatted_address').text(address);
        $('#yoto').text(yoto);
        $('#lat').text(lat_lng.lat());
        $('#lng').text(lat_lng.lng());
      }


      this.getClickLatLng = function (lat_lng, map) {
        //☆表示している地図上の緯度経度

        // マーカーを設置
        marker.setMap(null);
        marker = new google.maps.Marker({
          position: lat_lng,
          map: map
        });
        // 座標の中心をずらす
        map.panTo(lat_lng);
        //情報領域更新
        this.changeInfo(lat_lng, "")
      }

      this.loadGeoJson = function () {
        map.data.loadGeoJson('yoto_tokyo.geojson');
        var colors = {
          1: '#D3FFEB',
          2: '#E6F5DB',
          3: '#CDF68B',
          4: '#F4FED7',
          5: '#FFFEBB',
          6: '#FDEFEE',
          7: '#FEBD85',
          8: '#FED2F4',
          9: '#FD8FCA',
          10: '#A0ABD6',
          11: '#E2F8FF',
          12: '#ACD1FA',
          99: '#CCCCCC',
        }
        map.data.setStyle((feature) => {
          var color = feature.getProperty('A29_004');
          return {
            fillColor: colors[color],
            strokeWeight: 1
          };
        });
        map.data.addListener('click', (e) => {
          let yoto = e.feature.getProperty('A29_005');
          this.codeAddress({ 'location': e.latLng });
        });
      }
    }

    function initMap() {

      const gmap = new Gmap();
      gmap.init();

      // ボタンに指定したid要素を取得
      var button = document.getElementById("map_button");

      // ボタンが押された時の処理を登録
      button.onclick = function () {
        // フォームに入力された住所情報を取得
        // 取得した住所を引数に指定してgeocodeを実行
        var address = document.getElementById("address").value;
        gmap.codeAddress({ 'address': address });
      }

      //読み込まれたときに地図を表示
      // フォームに入力された住所情報を取得
      var address = document.getElementById("address").value;
      // 取得した住所を引数に指定してgeocodeを実行
      address = (address == "") ? "株式会社ietty" : address;
      gmap.loadGeoJson();
      gmap.codeAddress({ 'address': address });
    }


  </script>
</body>

</html>