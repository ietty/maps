<!DOCTYPE html>
<html>

<head>
  <title>ietty Real Estates Maps</title>
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>
</head>

<body>
  <h1>ietty 不動産Maps</h1>
  <p>
    <ul>
      <li>住所を入力してその場所の正確な住所・用途区域等を表示</li>
      <li>クリックで移動して再検索</li>
      <li>用途区域の色分け表示</li>
    </ul>
  </p>
  <form onsubmit="return false;">
    <input type="text" placeholder="株式会社ietty" id="address">
    <button type="submit" value="検索" id="map_button">検索</button>
  </form>
  <p>検索結果<br> 住所:
    <span id='formatted_address'></span></br>
    区域:<span id='yoto'></span></br>
    緯度:<span id='lat'></span></br>
    経度:<span id='lng'></span></br>
    </br>

    <!-- 地図を表示させる要素 -->
    <div class="map_box01">
      <div id="map-canvas" style="width: 1024px;height: 500px;"></div>
    </div>

  </p>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPnGpbDi_XQUZM1gyQj2GA8XzDDeJ4hMw&callback=initMap" async
    defer></script>

  <script>

    function Gmap() {
      let map;
      let geocoder;
      let marker;

      this.init = function () {
        // google.maps.Geocoder()コンストラクタのインスタンスを生成
        geocoder = new google.maps.Geocoder();
        // 地図表示に関するオプション
        const mapOptions = {
          zoom: 16,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        // 地図を表示させるインスタンスを生成
        map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
      }

      this.codeAddress = function (query) {
        // geocoder.geocode()メソッドを実行 
        geocoder.geocode(query, (results, status) => {
          if (status == google.maps.GeocoderStatus.OK) {
            this.reloadMap(results[0]);
          } else {
            // ジオコーディングが成功しなかった場合
            console.log('Geocode was not successful for the following reason: ' + status);
          }
        });

        // マップクリックをイベント登録
        map.addListener('click', (e) => {
          this.codeAddress({'location': e.latLng});
        });
      }

      // ジオコード成功時のMap書き換え
      this.reloadMap = function (result) {
        // 変換した緯度・経度情報を地図の中心に表示
        map.setCenter(result.geometry.location);
        // マーカー設定
        if (marker != undefined) marker.setMap(null);
        marker = new google.maps.Marker({ map: map, position: result.geometry.location });
        //情報領域の書き換え
        this.changeInfo(result.geometry.location, result.formatted_address);
      }

      this.changeInfo = function (lat_lng, address) {
        //情報領域の書き換え
        $('#lat').text(lat_lng.lat());
        $('#lng').text(lat_lng.lng());
        $('#formatted_address').text(address);
      }

      this.getClickLatLng = function (lat_lng, map) {
        //☆表示している地図上の緯度経度

        // マーカーを設置
        marker.setMap(null);
        marker = new google.maps.Marker({
          position: lat_lng,
          map: map
        });
        // 座標の中心をずらす
        map.panTo(lat_lng);
        //情報領域更新
        this.changeInfo(lat_lng, "")
      }

      this.loadGeoJson = function () {
        map.data.loadGeoJson('yoto_tokyo.geojson');
        map.data.setStyle(function (feature) {
          
          var color = feature.getProperty('fillColor');
          return {
            fillColor: 'green',
            strokeWeight: 1
          };
        });
        map.data.addListener('click', (e) => {
          this.codeAddress({'location': e.latLng});
        });
      }

    }

    function initMap() {

      const gmap = new Gmap();
      gmap.init();

      // ボタンに指定したid要素を取得
      var button = document.getElementById("map_button");

      // ボタンが押された時の処理を登録
      button.onclick = function () {
        // フォームに入力された住所情報を取得
        // 取得した住所を引数に指定してgeocodeを実行
        var address = document.getElementById("address").value;
        gmap.codeAddress({ 'address': address });
      }

      //読み込まれたときに地図を表示
      // フォームに入力された住所情報を取得
      var address = document.getElementById("address").value;
      // 取得した住所を引数に指定してgeocodeを実行
      address = (address == "") ? "株式会社ietty" : address;
      gmap.codeAddress({ 'address': address });
      gmap.loadGeoJson();
    }


  </script>
</body>

</html>