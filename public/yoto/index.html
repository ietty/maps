<!DOCTYPE html>
<html>
  <head>
    <title>ietty Real Estates Maps</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <h1>ietty 不動産Maps</h1>
    <p>
      <ul>
        <li>住所を入力してその場所の用途区域を表示</li>
        <li>クリックで移動して再検索</li>
        <li>用途区域の色分け表示</li>
      </ul>
    </p>
    <form onsubmit="return false;">
      <input type="text" value="株式会社ietty" id="address">
      <button type="button" value="検索" id="map_button">検索</button>
    </form>
    <!-- 地図を表示させる要素 -->
    <div class="map_box01"><div id="map-canvas" style="width: 1024px;height: 500px;"></div></div>
    
    <p>マーカーのある位置の情報<br>
      緯度:<span id="lat"></span></br>
      経度:<span id="lng"></span></br>
    </br>
      地図上をクリックするとマーカーを移動できます。
    </p>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPnGpbDi_XQUZM1gyQj2GA8XzDDeJ4hMw&callback=gmap.initMap" async defer></script>
 
    <script>
    var gmap = (function() {
      var map_storage = 'https://maps.ietty.me/yoto/';

      function codeAddress(address) {
        // google.maps.Geocoder()コンストラクタのインスタンスを生成
        var geocoder = new google.maps.Geocoder();
    
        // 地図表示に関するオプション
        var mapOptions = {
          zoom: 16,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        };
    
        // 地図を表示させるインスタンスを生成
        var map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
        
        //マーカー変数用意
        var marker;
        
        // geocoder.geocode()メソッドを実行 
        geocoder.geocode( { 'address': address}, function(results, status) {
          
          // ジオコーディングが成功した場合
          if (status == google.maps.GeocoderStatus.OK) {
            
            // 変換した緯度・経度情報を地図の中心に表示
            map.setCenter(results[0].geometry.location);
            
            //☆表示している地図上の緯度経度
            document.getElementById('lat').innerText=results[0].geometry.location.lat();
            document.getElementById('lng').innerText=results[0].geometry.location.lng();
            
            // マーカー設定
            marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
            });
          
          // ジオコーディングが成功しなかった場合
          } else {
            console.log('Geocode was not successful for the following reason: ' + status);
          }
        
        });
        
        // マップをクリックで位置変更
        map.addListener('click', function(e) {
          getClickLatLng(e.latLng, map);
        });
        function getClickLatLng(lat_lng, map) {
          
          //☆表示している地図上の緯度経度
          document.getElementById('lat').value=lat_lng.lat();
          document.getElementById('lng').value=lat_lng.lng();
            
          // マーカーを設置
          marker.setMap(null);
          marker = new google.maps.Marker({
            position: lat_lng,
            map: map
          });
        
          // 座標の中心をずらす
          map.panTo(lat_lng);
        }
      
        return map;
      }
      
      //inputのvalueで検索して地図を表示
      return {
        initMap: function() {

          // ボタンに指定したid要素を取得
          var button = document.getElementById("map_button");
          
          // ボタンが押された時の処理
          button.onclick = function() {
            // フォームに入力された住所情報を取得
            var address = document.getElementById("address").value;
            // 取得した住所を引数に指定してcodeAddress()関数を実行
            var map = codeAddress(address);
          }
          
          //読み込まれたときに地図を表示
          window.onload = function(){
            // フォームに入力された住所情報を取得
            var address = document.getElementById("address").value;
            // 取得した住所を引数に指定してcodeAddress()関数を実行
            var map = codeAddress(address);
            map.data.loadGeoJson('yoto_tokyo.geojson');
            map.data.setStyle(function (feature) {
              var color = feature.getProperty('fillColor');
              return {
                fillColor: 'green',
                strokeWeight: 1
              };
          });

          }
        }
      
      };
    
    })();
    </script>
  </body>
</html>

